<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - AI Caption Studio</title>
    <style>
        /* Theme System */
        :root {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --card-background: #2a2a3e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
        }
        
        [data-theme="purple-creative"] {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        [data-theme="ocean-blue"] {
            --primary-gradient: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            --background-gradient: linear-gradient(135deg, #0c4a6e 0%, #0891b2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--background-gradient); min-height: 100vh; color: var(--text-primary); padding: 20px; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        .admin-header { background: var(--card-background); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .admin-header h1 { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2rem; font-weight: 700; }
        .nav-links { display: flex; gap: 15px; }
        .nav-link { padding: 10px 20px; background: var(--primary-gradient); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: transform 0.2s; }
        .nav-link:hover { transform: translateY(-2px); }
        .admin-section { background: var(--card-background); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-secondary { 
            background: var(--card-background); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { 
            background: var(--text-secondary); 
            color: var(--card-background);
        }
        .btn-danger { background: #ef4444; color: white; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table th { background: #f8fafc; font-weight: 600; color: var(--text-primary); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .badge-admin { background: #8B5CF6; color: white; }
        .badge-user { background: #e2e8f0; color: #475569; }
        .badge-active { background: #10b981; color: white; }
        .badge-inactive { background: #ef4444; color: white; }
        .hidden { display: none; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        
        /* Modal Styling */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.5); 
        }
        .modal-content { 
            background-color: var(--card-background); 
            margin: 10% auto; 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 500px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
        }
        .modal-content h3 {
            margin: 0 0 20px 0;
            color: var(--text-primary);
        }
        .modal-content input[type="email"],
        .modal-content input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--card-background);
            color: var(--text-primary);
            box-sizing: border-box;
            font-size: 14px;
        }
        .modal-content input[type="email"]:focus,
        .modal-content input[type="text"]:focus {
            outline: none;
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        .modal-content label {
            color: var(--text-primary);
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
        }
        .modal-content input[type="checkbox"] {
            margin-right: 8px;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .admin-header { 
                flex-direction: column; 
                gap: 15px; 
                padding: 20px;
                text-align: center;
            }
            .nav-links { 
                flex-direction: column; 
                gap: 10px; 
                width: 100%;
            }
            .nav-link { 
                width: 100%; 
                text-align: center; 
                font-size: 14px;
                padding: 12px 20px;
            }
            .admin-section { 
                padding: 20px; 
                margin-bottom: 20px; 
            }
            .section-title { 
                font-size: 1.3rem; 
                margin-bottom: 15px; 
            }
            
            /* Mobile-friendly table wrapper */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            .table {
                min-width: 600px; /* Ensure table doesn't get too cramped */
                margin-top: 0;
            }
            .table th, .table td { 
                padding: 8px 10px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            /* Stack flex containers on mobile */
            .flex.justify-between {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            .flex.gap-2 {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Button adjustments */
            .btn {
                font-size: 14px;
                padding: 10px 15px;
                min-width: 100px;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .admin-section { 
                padding: 15px; 
            }
            .section-title { 
                font-size: 1.2rem; 
            }
            .nav-link {
                font-size: 13px;
                padding: 10px 15px;
            }
            .table th, .table td { 
                padding: 6px 8px;
                font-size: 13px;
            }
            .btn {
                font-size: 13px;
                padding: 8px 12px;
                min-width: 80px;
            }
            .flex.gap-2 {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-header" id="adminHeader" style="display: none;">
            <h1>üë• Manage Users</h1>
            <div class="nav-links">
                <select id="themeSelector" onchange="changeTheme()" style="padding: 10px 20px; border: none; border-radius: 8px; margin-right: 10px; cursor: pointer; font-weight: 500;">
                    <option value="default">üé® Default</option>
                    <option value="dark">üåô Dark</option>
                    <option value="purple-creative">üíú Purple</option>
                    <option value="ocean-blue">üåä Ocean</option>
                </select>
                <a href="/admin" class="nav-link">üè† Dashboard</a>
                <a href="/admin/tiers" class="nav-link">üèÜ Tiers</a>
                <a href="/" class="nav-link">üè† Main App</a>
                <button class="nav-link" onclick="logout()" style="border: none; cursor: pointer;">üö™ Logout</button>
            </div>
        </div>

        <div id="loginRequired" class="admin-section">
            <h2>üîê Admin Access Required</h2>
            <p>Please <a href="/" style="color: var(--accent-color);">login with an admin account</a> to access this page.</p>
        </div>

        <div id="adminContent" class="hidden">
            <!-- User Management -->
            <div class="admin-section">
                <div class="flex justify-between items-center">
                    <div class="section-title">All Users</div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="refreshUsers()">üîÑ Refresh</button>
                        <button class="btn btn-secondary" onclick="showInviteModal()">üìß Send Invite</button>
                        <button class="btn btn-primary" onclick="showAddUserModal()">üë§ Add User</button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Type</th>
                                <th>Tier</th>
                                <th>Usage Today</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            <tr><td colspan="7">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pending Invites Management -->
            <div class="admin-section">
                <div class="flex justify-between items-center">
                    <div class="section-title">üìß Pending Invites</div>
                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="refreshInvites()">üîÑ Refresh</button>
                        <button class="btn btn-secondary" onclick="showInviteModal()">üìß Send New Invite</button>
                    </div>
                </div>
                
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Invited By</th>
                                <th>Tier</th>
                                <th>Created</th>
                                <th>Expires</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invitesTable">
                            <tr><td colspan="6">Loading invites...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Delete User</h3>
            <p id="deleteModalText">Are you sure you want to delete this user?</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDelete()">Delete User</button>
            </div>
        </div>
    </div>

    <!-- Second Confirmation Modal -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>üîê Final Confirmation</h3>
            <p>To confirm deletion, please type <strong>"DELETE"</strong> (all caps):</p>
            <input type="text" id="confirmInput" placeholder="Type DELETE here" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;">
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-danger" onclick="finalDelete()">Confirm Delete</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3>üë§ Add New User</h3>
            <div style="margin: 20px 0;">
                <label for="addUserEmail">Email Address:</label>
                <input type="email" id="addUserEmail" placeholder="Enter user email">
            </div>
            <div style="margin: 20px 0;">
                <label for="addUserAdmin" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="addUserAdmin">
                    <span>Make this user an admin</span>
                </label>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createUser()">Create User</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" style="display: none; position: fixed; top: 20px; right: 20px; padding: 15px; border-radius: 5px; color: white; z-index: 1001;"></div>

    <script>
        let currentDeleteUserId = null;
        let currentDeleteUserEmail = null;

        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.isAdmin) {
                        document.getElementById('adminHeader').style.display = 'flex';
                        document.getElementById('loginRequired').classList.add('hidden');
                        document.getElementById('adminContent').classList.remove('hidden');
                        loadUsers();
                        // Only load invites if we're on the admin users page
                        if (document.getElementById('invitesTable')) {
                            loadInvites();
                        }
                    }
                }
            } catch (error) {
            }
        }

        let availableTiers = [];

        async function loadUsers() {
            try {
                // Load both users and tiers in parallel
                const [usersResponse, tiersResponse] = await Promise.all([
                    fetch('/api/admin/users', {
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                    }),
                    fetch('/api/admin/tiers', {
                        headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                    })
                ]);
                
                if (usersResponse.ok && tiersResponse.ok) {
                    const users = await usersResponse.json();
                    availableTiers = await tiersResponse.json();
                    
                    const tbody = document.getElementById('usersTable');
                    tbody.innerHTML = users.map(user => 
                        '<tr>' +
                        '<td>' + user.email + '</td>' +
                        '<td><span class="badge ' + (user.is_admin ? 'badge-admin">üõ†Ô∏è Admin' : 'badge-user">üë§ User') + '</span></td>' +
                        '<td>' + createTierDropdown(user) + '</td>' +
                        '<td>' + (user.usage_today || 0) + '/' + (user.daily_limit === -1 ? '‚àû' : user.daily_limit || 0) + '</td>' +
                        '<td><span class="badge ' + (user.is_active ? 'badge-active">‚úÖ Active' : 'badge-inactive">‚ùå Inactive') + '</span></td>' +
                        '<td>' + new Date(user.created_at).toLocaleDateString() + '</td>' +
                        '<td>' +
                        '<div class="flex gap-2">' +
                        (!user.is_admin ? '<button class="btn btn-secondary" onclick="makeAdmin(' + user.id + ')">üõ†Ô∏è Make Admin</button>' : '') +
                        (user.is_active ? 
                            '<button class="btn btn-danger" onclick="toggleUser(' + user.id + ')">‚ùå Deactivate</button>' : 
                            '<button class="btn btn-primary" onclick="toggleUser(' + user.id + ')">‚úÖ Activate</button>') +
                        '<button class="btn btn-danger" onclick="deleteUser(' + user.id + ', &quot;' + user.email + '&quot;)">üóëÔ∏è Delete</button>' +
                        '</div>' +
                        '</td>' +
                        '</tr>'
                    ).join('');
                } else {
                    throw new Error('Failed to load users or tiers');
                }
            } catch (error) {
                document.getElementById('usersTable').innerHTML = '<tr><td colspan="7">Failed to load users</td></tr>';
            }
        }

        function createTierDropdown(user) {
            let options = '<option value="">No tier</option>';
            
            availableTiers.forEach(tier => {
                const selected = user.tier_id === tier.id ? 'selected' : '';
                const limitText = tier.daily_limit === -1 ? 'Unlimited' : tier.daily_limit + ' per day';
                options += '<option value="' + tier.id + '" ' + selected + '>' + tier.name + ' (' + limitText + ')</option>';
            });
            
            return '<select class="form-input" style="width: 200px; padding: 5px;" onchange="updateUserTier(' + user.id + ', this.value)">' + 
                   options + 
                   '</select>';
        }

        async function updateUserTier(userId, tierId) {
            try {
                const response = await fetch('/api/admin/users/' + userId + '/tier', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    },
                    body: JSON.stringify({ tierId: tierId || null })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ User tier updated successfully', 'success');
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                    loadUsers(); // Reload to reset the dropdown
                }
            } catch (error) {
                showNotification('‚ùå Failed to update tier: ' + error.message, 'error');
                loadUsers(); // Reload to reset the dropdown
            }
        }

        async function makeAdmin(userId) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            try {
                const response = await fetch('/api/admin/users/' + userId + '/make-admin', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ User promoted to admin successfully!', 'success');
                    loadUsers();
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to promote user: ' + error.message, 'error');
            }
        }

        async function toggleUser(userId) {
            try {
                const response = await fetch('/api/admin/users/' + userId + '/toggle', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ User status updated successfully!', 'success');
                    loadUsers();
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to update user: ' + error.message, 'error');
            }
        }

        function deleteUser(userId, userEmail) {
            currentDeleteUserId = userId;
            currentDeleteUserEmail = userEmail;
            document.getElementById('deleteModalText').textContent = 
                'Are you sure you want to permanently delete user "' + userEmail + '" and ALL their data?';
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentDeleteUserId = null;
            currentDeleteUserEmail = null;
        }

        function confirmDelete() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('confirmInput').value = '';
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('confirmInput').value = '';
        }

        async function finalDelete() {
            const confirmText = document.getElementById('confirmInput').value;
            if (confirmText !== 'DELETE') {
                showNotification('‚ùå Deletion cancelled - you must type "DELETE" exactly', 'error');
                return;
            }
            
            document.getElementById('confirmModal').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/users/' + currentDeleteUserId, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ ' + result.message, 'success');
                    loadUsers();
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to delete user: ' + error.message, 'error');
            }
            
            currentDeleteUserId = null;
            currentDeleteUserEmail = null;
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        function showAddUserModal() {
            document.getElementById('addUserEmail').value = '';
            document.getElementById('addUserAdmin').checked = false;
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        async function createUser() {
            const email = document.getElementById('addUserEmail').value.trim();
            const isAdmin = document.getElementById('addUserAdmin').checked;
            
            if (!email) {
                showNotification('‚ùå Please enter an email address', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                showNotification('‚ùå Please enter a valid email address', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    },
                    body: JSON.stringify({ 
                        email: email,
                        isAdmin: isAdmin
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ User created successfully!', 'success');
                    closeAddUserModal();
                    loadUsers();
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to create user: ' + error.message, 'error');
            }
        }

        function refreshUsers() {
            loadUsers();
        }

        async function loadInvites() {
            try {
                // Check if invitesTable element exists first
                const tbody = document.getElementById('invitesTable');
                if (!tbody) {
                    return;
                }

                const response = await fetch('/api/admin/invites', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                if (response.ok) {
                    const invites = await response.json();
                    
                    if (invites.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #666;">No pending invites</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = invites.map(invite => {
                        const created = new Date(invite.created_at).toLocaleDateString();
                        const expires = new Date(invite.expires_at).toLocaleDateString();
                        const invitedBy = invite.invited_by_email || 'System';
                        const tier = invite.tier_name || 'Default';
                        
                        return '<tr>' +
                            '<td>' + invite.email + '</td>' +
                            '<td>' + invitedBy + '</td>' +
                            '<td>' + tier + '</td>' +
                            '<td>' + created + '</td>' +
                            '<td>' + expires + '</td>' +
                            '<td>' +
                            '<div class="flex gap-2">' +
                            '<button class="btn btn-primary" onclick="window.resendInvite(&quot;' + invite.token + '&quot;)">üîÑ Resend</button>' +
                            '<button class="btn btn-danger" onclick="window.deleteInvite(&quot;' + invite.token + '&quot;, &quot;' + invite.email + '&quot;)">üóëÔ∏è Delete</button>' +
                            '</div>' +
                            '</td>' +
                            '</tr>';
                    }).join('');
                } else {
                    tbody.innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Failed to load invites</td></tr>';
                }
            } catch (error) {
                // Don't try to access DOM if there's an error and element might not exist
                const tbody = document.getElementById('invitesTable');
                if (tbody) {
                    tbody.innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #ef4444;">Error loading invites</td></tr>';
                }
            }
        }

        function refreshInvites() {
            loadInvites();
        }

        // Make functions globally accessible for onclick handlers
        window.resendInvite = async function(token) {
            if (!confirm('Are you sure you want to resend this invitation?')) return;
            
            try {
                const response = await fetch('/api/admin/invites/' + token + '/resend', {
                    method: 'POST',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ ' + result.message, 'success');
                    loadInvites(); // Refresh the list
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to resend invitation: ' + error.message, 'error');
            }
        };

        window.deleteInvite = async function(token, email) {
            
            if (!confirm('Are you sure you want to delete the invitation for "' + email + '"?')) {
                return;
            }
            
            
            try {
                const response = await fetch('/api/admin/invites/' + token, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ ' + result.message, 'success');
                    loadInvites(); // Refresh the list
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to delete invitation: ' + error.message, 'error');
            }
        };

        function showInviteModal() {
            const email = prompt('Enter email address to invite:');
            if (email) {
                sendInvite(email);
            }
        }

        async function sendInvite(email) {
            try {
                const response = await fetch('/api/admin/invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    },
                    body: JSON.stringify({ email })
                });

                const result = await response.json();
                if (result.success) {
                    showNotification('‚úÖ Invitation sent successfully!', 'success');
                    loadInvites(); // Refresh the invites list
                } else {
                    showNotification('‚ùå Error: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Failed to send invitation: ' + error.message, 'error');
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_email');
            document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/';
        }

        // Theme management functions
        function changeTheme() {
            const themeSelector = document.getElementById('themeSelector');
            const selectedTheme = themeSelector.value;
            
            // Remove existing theme classes
            document.body.removeAttribute('data-theme');
            
            // Apply new theme
            if (selectedTheme !== 'default') {
                document.body.setAttribute('data-theme', selectedTheme);
            }
            
            // Save theme preference
            localStorage.setItem('selectedTheme', selectedTheme);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            const themeSelector = document.getElementById('themeSelector');
            
            if (themeSelector) {
                themeSelector.value = savedTheme;
                
                // Apply the saved theme
                if (savedTheme !== 'default') {
                    document.body.setAttribute('data-theme', savedTheme);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            loadSavedTheme();
        });
    </script>
</body>
</html>