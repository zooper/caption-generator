<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AI Caption Studio</title>
    <style>
        /* Theme System */
        :root {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            --card-background: #2a2a3e;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
        }
        
        [data-theme="purple-creative"] {
            --primary-gradient: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        [data-theme="ocean-blue"] {
            --primary-gradient: linear-gradient(135deg, #2196F3 0%, #21CBF3 100%);
            --background-gradient: linear-gradient(135deg, #0c4a6e 0%, #0891b2 100%);
            --card-background: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e2e8f0;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--background-gradient); min-height: 100vh; color: var(--text-primary); padding: 20px; transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; }
        .admin-header { background: var(--card-background); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .admin-header h1 { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 2rem; font-weight: 700; }
        .nav-links { display: flex; gap: 15px; }
        .nav-link { padding: 10px 20px; background: var(--primary-gradient); color: white; text-decoration: none; border-radius: 8px; font-weight: 500; transition: transform 0.2s; }
        .nav-link:hover { transform: translateY(-2px); }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .admin-card { background: var(--card-background); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .card-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 15px; color: var(--text-primary); display: flex; align-items: center; gap: 10px; }
        .stat-value { font-size: 2.5rem; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; margin-top: 5px; }
        .admin-section { background: var(--card-background); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .section-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4); }
        .btn-secondary { 
            background: var(--card-background); 
            color: var(--text-primary); 
            border: 1px solid var(--border-color);
        }
        .btn-secondary:hover { 
            background: var(--text-secondary); 
            color: var(--card-background);
        }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .table th { background: #f8fafc; font-weight: 600; color: var(--text-primary); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-primary); }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--card-background); color: var(--text-primary); }
        .form-input:focus { outline: none; border-color: #8B5CF6; box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1); }
        .form-help { display: block; margin-top: 5px; font-size: 12px; color: var(--text-secondary); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .modal-content { background-color: var(--card-background); margin: 10% auto; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; }
        .hidden { display: none; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-3 { gap: 12px; }
        .mb-4 { margin-bottom: 16px; }
        
        /* Mobile responsiveness for admin sections */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .admin-header { 
                flex-direction: column; 
                gap: 15px; 
                padding: 20px;
                text-align: center;
            }
            .nav-links { 
                flex-direction: column; 
                gap: 10px; 
                width: 100%;
            }
            .nav-link { 
                width: 100%; 
                text-align: center; 
                font-size: 14px;
                padding: 12px 20px;
            }
            .admin-section { 
                padding: 20px; 
                margin-bottom: 20px; 
            }
            .section-title { 
                font-size: 1.3rem; 
                margin-bottom: 15px; 
            }
            .admin-grid { 
                grid-template-columns: 1fr; 
                gap: 15px; 
            }
            .stat-card { 
                padding: 20px; 
            }
            
            /* Mobile-friendly table wrapper */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
                border: 1px solid var(--border-color);
            }
            .table {
                min-width: 600px; /* Ensure table doesn't get too cramped */
                margin-top: 0;
            }
            .table th, .table td { 
                padding: 8px 10px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            /* Stack flex containers on mobile */
            .flex.justify-between {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            .flex.gap-2, .flex.gap-3 {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Button adjustments */
            .btn {
                font-size: 14px;
                padding: 10px 15px;
                min-width: 100px;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
            
            /* Form improvements */
            .form-input, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
        
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .admin-section { 
                padding: 15px; 
            }
            .section-title { 
                font-size: 1.2rem; 
            }
            .nav-link {
                font-size: 13px;
                padding: 10px 15px;
            }
            .table th, .table td { 
                padding: 6px 8px;
                font-size: 13px;
            }
            .btn {
                font-size: 13px;
                padding: 8px 12px;
                min-width: 80px;
            }
            .flex.gap-2, .flex.gap-3 {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-header" id="adminHeader" style="display: none;">
            <h1>üõ†Ô∏è Admin Dashboard</h1>
            <div class="nav-links">
                <select id="themeSelector" onchange="changeTheme()" style="padding: 10px 20px; border: none; border-radius: 8px; margin-right: 10px; cursor: pointer; font-weight: 500;">
                    <option value="default">üé® Default</option>
                    <option value="dark">üåô Dark</option>
                    <option value="purple-creative">üíú Purple</option>
                    <option value="ocean-blue">üåä Ocean</option>
                </select>
                <a href="/" class="nav-link">üè† Main App</a>
                <a href="/admin/users" class="nav-link">üë• Users</a>
                <a href="/admin/tiers" class="nav-link">üèÜ Tiers</a>
                <button class="nav-link" onclick="logout()" style="border: none; cursor: pointer;">üö™ Logout</button>
            </div>
        </div>

        <div id="loginRequired" class="admin-section">
            <h2>üîê Admin Access Required</h2>
            <p>Please <a href="/" style="color: var(--accent-color);">login with an admin account</a> to access this page.</p>
        </div>

        <div id="adminContent" class="hidden">
            <!-- Stats Grid -->
            <div class="admin-grid">
                <div class="admin-card">
                    <div class="card-title">üë• Total Users</div>
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Registered users</div>
                </div>
                <div class="admin-card">
                    <div class="card-title">üìä Total Queries</div>
                    <div class="stat-value" id="totalQueries">-</div>
                    <div class="stat-label">AI generations</div>
                </div>
                <div class="admin-card">
                    <div class="card-title">üé´ Pending Invites</div>
                    <div class="stat-value" id="pendingInvites">-</div>
                    <div class="stat-label">Awaiting acceptance</div>
                </div>
                <div class="admin-card">
                    <div class="card-title">üèÜ Active Tiers</div>
                    <div class="stat-value" id="activeTiers">-</div>
                    <div class="stat-label">User tier levels</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-section">
                <div class="section-title">‚ö° Quick Actions</div>
                <div class="flex gap-3">
                    <button class="btn btn-primary" onclick="showInviteModal()">üìß Send Invite</button>
                    <button class="btn btn-secondary" onclick="window.location.href='/admin/tiers'">üèÜ Manage Tiers</button>
                    <button class="btn btn-secondary" onclick="window.location.href='/admin/users'">üë• Manage Users</button>
                    <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh Data</button>
                </div>
            </div>

            <!-- Recent Users -->
            <div class="admin-section">
                <div class="section-title">üë• Recent Users</div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Usage Today</th>
                                <th>Total Usage</th>
                                <th>Joined</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentUsers">
                        <tr><td colspan="6">Loading...</td></tr>
                    </tbody>
                </table>
                </div>
            </div>

            <!-- Recent Invites -->
            <div class="admin-section">
                <div class="section-title">üìß Recent Invites</div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Invited By</th>
                                <th>Created</th>
                                <th>Expires</th>
                            </tr>
                        </thead>
                        <tbody id="recentInvites">
                            <tr><td colspan="4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- System Settings -->
            <div class="admin-section">
                <div class="section-title">‚öôÔ∏è System Settings</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">üîì Registration Status</label>
                            <select id="registrationOpen" class="form-input">
                                <option value="true">Open - Anyone can register</option>
                                <option value="false">Closed - Invite only</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="flex gap-3" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="saveSystemSettings()">üíæ Save Settings</button>
                    <button class="btn btn-secondary" onclick="loadSystemSettings()">üîÑ Reload Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <h2 class="mb-4">üìß Send Invitation</h2>
            
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" id="inviteEmail" class="form-input" placeholder="user@example.com" required>
                <small class="form-help">The user will receive a magic link to create their account</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Assign Tier (Optional)</label>
                <select id="inviteTier" class="form-input">
                    <option value="">No tier assigned (default)</option>
                </select>
                <small class="form-help">Assign a usage tier to the invited user</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Personal Message (Optional)</label>
                <textarea id="inviteMessage" class="form-input" rows="3" placeholder="Add a personal welcome message..."></textarea>
                <small class="form-help">This message will be included in the invitation email</small>
            </div>
            
            <div class="flex justify-between gap-3 mt-6">
                <button class="btn btn-secondary" onclick="closeInviteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="sendInvite()">
                    <span id="inviteButtonText">üìß Send Invite</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        async function checkAdminAuth() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') },
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const user = await response.json();
                    if (user.isAdmin) {
                        document.getElementById('loginRequired').classList.add('hidden');
                        document.getElementById('adminHeader').style.display = 'flex';
                        document.getElementById('adminContent').classList.remove('hidden');
                        loadAdminData();
                    }
                }
            } catch (error) {
            }
        }

        async function loadAdminData() {
            try {
                await Promise.all([
                    loadStats(),
                    loadRecentUsers(),
                    loadRecentInvites(),
                    loadSystemSettings()
                ]);
            } catch (error) {
            }
        }

        async function loadStats() {
            try {
                const [statsResponse, invitesResponse, tiersResponse] = await Promise.all([
                    fetch('/api/admin/stats', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') } }),
                    fetch('/api/admin/invites', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') } }),
                    fetch('/api/admin/tiers', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') } })
                ]);

                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalQueries').textContent = stats.totalQueries;
                } else {
                }

                if (invitesResponse.ok) {
                    const invites = await invitesResponse.json();
                    document.getElementById('pendingInvites').textContent = invites.length;
                } else {
                }

                if (tiersResponse.ok) {
                    const tiers = await tiersResponse.json();
                    document.getElementById('activeTiers').textContent = tiers.length;
                } else {
                }
            } catch (error) {
            }
        }

        async function loadRecentUsers() {
            try {
                const response = await fetch('/api/admin/usage-stats', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                
                if (response.ok) {
                    const users = await response.json();
                    const tbody = document.getElementById('recentUsers');
                    tbody.innerHTML = users.slice(0, 10).map(user => 
                        '<tr>' +
                        '<td>' + user.email + '</td>' +
                        '<td>' + (user.tier_name || 'No tier') + '</td>' +
                        '<td>' + user.usage_today + '/' + (user.daily_limit === -1 ? '‚àû' : user.daily_limit) + '</td>' +
                        '<td>' + (user.total_usage || 0) + '</td>' +
                        '<td>' + new Date(user.created_at).toLocaleDateString() + '</td>' +
                        '<td><span style="color: green;">‚óè</span> Active</td>' +
                        '</tr>'
                    ).join('');
                } else {
                    document.getElementById('recentUsers').innerHTML = '<tr><td colspan="6">Failed to load users (Status: ' + response.status + ')</td></tr>';
                }
            } catch (error) {
                document.getElementById('recentUsers').innerHTML = '<tr><td colspan="6">Failed to load users: ' + error.message + '</td></tr>';
            }
        }

        async function loadRecentInvites() {
            try {
                const response = await fetch('/api/admin/invites', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                
                if (response.ok) {
                    const invites = await response.json();
                    const tbody = document.getElementById('recentInvites');
                    tbody.innerHTML = invites.slice(0, 5).map(invite => 
                        '<tr>' +
                        '<td>' + invite.email + '</td>' +
                        '<td>' + invite.invited_by_email + '</td>' +
                        '<td>' + new Date(invite.created_at).toLocaleDateString() + '</td>' +
                        '<td>' + new Date(invite.expires_at).toLocaleDateString() + '</td>' +
                        '</tr>'
                    ).join('');
                } else {
                    document.getElementById('recentInvites').innerHTML = '<tr><td colspan="4">Failed to load invites (Status: ' + response.status + ')</td></tr>';
                }
            } catch (error) {
                document.getElementById('recentInvites').innerHTML = '<tr><td colspan="4">Failed to load invites: ' + error.message + '</td></tr>';
            }
        }

        async function showInviteModal() {
            // Load available tiers
            try {
                const response = await fetch('/api/admin/tiers', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                if (response.ok) {
                    const tiers = await response.json();
                    const tierSelect = document.getElementById('inviteTier');
                    
                    // Clear existing options except default
                    tierSelect.innerHTML = '<option value="">No tier assigned (default)</option>';
                    
                    // Add tier options
                    tiers.forEach(tier => {
                        const limitText = tier.daily_limit === -1 ? 'Unlimited' : tier.daily_limit + ' per day';
                        const option = document.createElement('option');
                        option.value = tier.id;
                        option.textContent = tier.name + ' (' + limitText + ')';
                        tierSelect.appendChild(option);
                    });
                }
            } catch (error) {
            }
            
            document.getElementById('inviteModal').style.display = 'block';
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteTier').value = '';
            document.getElementById('inviteMessage').value = '';
            document.getElementById('inviteButtonText').textContent = 'üìß Send Invite';
        }

        async function sendInvite() {
            const email = document.getElementById('inviteEmail').value;
            const tierId = document.getElementById('inviteTier').value;
            const personalMessage = document.getElementById('inviteMessage').value;
            const buttonText = document.getElementById('inviteButtonText');
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            // Show loading state
            buttonText.textContent = '‚è≥ Sending...';
            
            try {
                const inviteData = { email };
                
                // Add tier if selected
                if (tierId) {
                    inviteData.tierId = parseInt(tierId);
                }
                
                // Add personal message if provided
                if (personalMessage.trim()) {
                    inviteData.personalMessage = personalMessage.trim();
                }

                const response = await fetch('/api/admin/invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    },
                    body: JSON.stringify(inviteData)
                });

                const result = await response.json();
                if (result.success) {
                    buttonText.textContent = '‚úÖ Sent!';
                    setTimeout(() => {
                        alert('‚úÖ Invitation sent successfully!');
                        closeInviteModal();
                        loadAdminData();
                    }, 500);
                } else {
                    buttonText.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        alert('‚ùå Error: ' + result.error);
                        buttonText.textContent = 'üìß Send Invite';
                    }, 1500);
                }
            } catch (error) {
                buttonText.textContent = '‚ùå Error';
                setTimeout(() => {
                    alert('‚ùå Failed to send invitation: ' + error.message);
                    buttonText.textContent = 'üìß Send Invite';
                }, 1500);
            }
        }

        function refreshData() {
            loadAdminData();
        }

        async function loadSystemSettings() {
            try {
                const response = await fetch('/api/admin/settings', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('auth_token') }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('adminEmailDisplay').value = data.adminEmail;
                    document.getElementById('registrationOpen').value = data.settings.registration_open || 'true';
                }
            } catch (error) {
            }
        }

        async function saveSystemSettings() {
            try {
                const registrationValue = document.getElementById('registrationOpen').value;
                
                const settings = {
                    registration_open: registrationValue
                };

                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('auth_token')
                    },
                    body: JSON.stringify({ settings })
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ System settings saved successfully!');
                    // Reload settings to verify they were saved
                    setTimeout(() => {
                        loadSystemSettings();
                    }, 500);
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Failed to save system settings: ' + error.message);
            }
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
            }
            
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_email');
            document.cookie = 'auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            window.location.href = '/';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('inviteModal');
            if (event.target === modal) {
                closeInviteModal();
            }
        }

        // Theme management functions
        function changeTheme() {
            const themeSelector = document.getElementById('themeSelector');
            const selectedTheme = themeSelector.value;
            
            // Remove existing theme classes
            document.body.removeAttribute('data-theme');
            
            // Apply new theme
            if (selectedTheme !== 'default') {
                document.body.setAttribute('data-theme', selectedTheme);
            }
            
            // Save theme preference
            localStorage.setItem('selectedTheme', selectedTheme);
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            const themeSelector = document.getElementById('themeSelector');
            
            if (themeSelector) {
                themeSelector.value = savedTheme;
                
                // Apply the saved theme
                if (savedTheme !== 'default') {
                    document.body.setAttribute('data-theme', savedTheme);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            loadSavedTheme();
        });
    </script>
</body>
</html>