<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - AI Caption Studio Admin</title>
    <link rel="stylesheet" href="themes.css">
    <script src="theme-loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .admin-header h1 {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2rem;
            font-weight: 700;
        }

        .admin-nav {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-btn, .action-btn {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 93, 230, 0.3);
        }

        .nav-btn.secondary {
            background: #f5f5f5;
            color: #333;
            border: 2px solid #ddd;
        }

        .nav-btn.secondary:hover {
            background: #e9e9e9;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: #333;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 4px solid #8B5CF6;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #8B5CF6;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .invite-form {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .invite-form input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .invite-form input:focus {
            outline: none;
            border-color: #8B5CF6;
        }

        .registration-control {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #ccc;
            border-radius: 25px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #8B5CF6;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th,
        .users-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .users-table th {
            background: #f8f9ff;
            color: #333;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .users-table tr:hover {
            background: #f8f9ff;
        }

        .user-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-status.active {
            background: #d4edda;
            color: #155724;
        }

        .user-status.inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .user-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #e8f0ff;
            color: #8B5CF6;
        }

        .user-role.admin {
            background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%);
            color: white;
        }

        .user-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn.small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .action-btn.danger {
            background: #dc3545;
        }

        .action-btn.danger:hover {
            background: #c82333;
            box-shadow: 0 3px 10px rgba(220, 53, 69, 0.3);
        }

        .action-btn.warning {
            background: #ffc107;
            color: #333;
        }

        .action-btn.warning:hover {
            background: #e0a800;
            box-shadow: 0 3px 10px rgba(255, 193, 7, 0.3);
        }

        .invites-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .invites-table th,
        .invites-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .invites-table th {
            background: #f8f9ff;
            color: #333;
            font-weight: 600;
        }

        .notification {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        @media (max-width: 768px) {
            .admin-header {
                text-align: center;
            }

            .invite-form {
                flex-direction: column;
            }

            .invite-form input {
                min-width: auto;
            }

            .users-table,
            .invites-table {
                font-size: 14px;
            }

            .users-table th,
            .users-table td,
            .invites-table th,
            .invites-table td {
                padding: 10px 8px;
            }

            .user-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div>
                <h1>üë• User Management</h1>
                <p style="color: #666; margin-top: 8px;">Manage users, invitations, and registration settings</p>
            </div>
            <div class="admin-nav">
                <a href="/" class="nav-btn secondary">üè† Main App</a>
                <a href="/admin" class="nav-btn secondary">üìä Analytics</a>
                <a href="/admin/tiers" class="nav-btn secondary">üè∑Ô∏è Tiers</a>
                <button id="logoutBtn" class="nav-btn secondary">üö™ Logout</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>

        <!-- Stats Section -->
        <div class="admin-section">
            <div class="section-header">
                <h2>üìà Overview</h2>
            </div>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">--</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">--</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingInvites">--</div>
                    <div class="stat-label">Pending Invites</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="registrationStatus">--</div>
                    <div class="stat-label">Registration</div>
                </div>
            </div>
        </div>

        <!-- Registration Control -->
        <div class="admin-section">
            <div class="section-header">
                <h2>üîê Registration Control</h2>
            </div>
            <div class="registration-control">
                <div class="toggle-switch" id="registrationToggle"></div>
                <div>
                    <strong>Registration Status</strong>
                    <p style="color: #666; margin-top: 4px;" id="registrationDescription">
                        Control whether new users can register directly or need invitations
                    </p>
                </div>
            </div>
        </div>

        <!-- Send Invitations -->
        <div class="admin-section">
            <div class="section-header">
                <h2>‚úâÔ∏è Send Invitation</h2>
            </div>
            <div class="invite-form">
                <input type="email" id="inviteEmail" placeholder="Enter email address to invite" required>
                <button class="action-btn" id="sendInviteBtn">
                    <span>üìß Send Invitation</span>
                </button>
            </div>
        </div>

        <!-- Pending Invitations -->
        <div class="admin-section">
            <div class="section-header">
                <h2>‚è≥ Pending Invitations</h2>
                <button class="action-btn" id="refreshInvitesBtn">üîÑ Refresh</button>
            </div>
            <div id="invitesContainer">
                <div class="empty-state">
                    <h3>Loading invitations...</h3>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="admin-section">
            <div class="section-header">
                <h2>üë§ All Users</h2>
                <button class="action-btn" id="refreshUsersBtn">üîÑ Refresh</button>
            </div>
            <div id="usersContainer">
                <div class="empty-state">
                    <h3>Loading users...</h3>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AdminUserManager {
            constructor() {
                this.authToken = localStorage.getItem('auth_token');
                this.currentUser = null;
                
                if (!this.authToken) {
                    window.location.href = '/auth';
                    return;
                }

                this.initializeElements();
                this.bindEvents();
                this.checkAdminAccess();
            }

            initializeElements() {
                this.notification = document.getElementById('notification');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.registrationToggle = document.getElementById('registrationToggle');
                this.registrationDescription = document.getElementById('registrationDescription');
                this.inviteEmail = document.getElementById('inviteEmail');
                this.sendInviteBtn = document.getElementById('sendInviteBtn');
                this.refreshUsersBtn = document.getElementById('refreshUsersBtn');
                this.refreshInvitesBtn = document.getElementById('refreshInvitesBtn');
                this.usersContainer = document.getElementById('usersContainer');
                this.invitesContainer = document.getElementById('invitesContainer');
                
                // Stats elements
                this.totalUsers = document.getElementById('totalUsers');
                this.activeUsers = document.getElementById('activeUsers');
                this.pendingInvites = document.getElementById('pendingInvites');
                this.registrationStatus = document.getElementById('registrationStatus');
                
                // Store tiers data
                this.availableTiers = [];
            }

            bindEvents() {
                this.logoutBtn.addEventListener('click', this.logout.bind(this));
                this.registrationToggle.addEventListener('click', this.toggleRegistration.bind(this));
                this.sendInviteBtn.addEventListener('click', this.sendInvitation.bind(this));
                this.refreshUsersBtn.addEventListener('click', this.loadUsers.bind(this));
                this.refreshInvitesBtn.addEventListener('click', this.loadInvites.bind(this));
                this.inviteEmail.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendInvitation();
                });
            }

            async checkAdminAccess() {
                try {
                    const response = await fetch('/api/auth/me', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        this.currentUser = await response.json();
                        if (!this.currentUser.isAdmin) {
                            this.showNotification('Admin access required', 'error');
                            setTimeout(() => window.location.href = '/', 2000);
                            return;
                        }
                        this.initializeData();
                    } else {
                        window.location.href = '/auth';
                    }
                } catch (error) {
                    console.error('Admin access check failed:', error);
                    window.location.href = '/auth';
                }
            }

            async initializeData() {
                await Promise.all([
                    this.loadUsers(),
                    this.loadInvites(),
                    this.loadRegistrationStatus(),
                    this.loadTiers()
                ]);
                this.updateStats();
            }

            async loadUsers() {
                try {
                    this.setLoading('usersContainer', true);
                    const response = await fetch('/api/admin/users', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        const users = await response.json();
                        this.renderUsers(users);
                        this.updateUserStats(users);
                    } else {
                        throw new Error('Failed to load users');
                    }
                } catch (error) {
                    console.error('Error loading users:', error);
                    this.usersContainer.innerHTML = '<div class="empty-state"><h3>‚ùå Failed to load users</h3></div>';
                } finally {
                    this.setLoading('usersContainer', false);
                }
            }

            async loadInvites() {
                try {
                    this.setLoading('invitesContainer', true);
                    const response = await fetch('/api/admin/invites', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        const invites = await response.json();
                        this.renderInvites(invites);
                        this.updateInviteStats(invites);
                    } else {
                        throw new Error('Failed to load invites');
                    }
                } catch (error) {
                    console.error('Error loading invites:', error);
                    this.invitesContainer.innerHTML = '<div class="empty-state"><h3>‚ùå Failed to load invites</h3></div>';
                } finally {
                    this.setLoading('invitesContainer', false);
                }
            }

            async loadRegistrationStatus() {
                try {
                    const response = await fetch('/api/auth/registration-status');
                    if (response.ok) {
                        const data = await response.json();
                        this.updateRegistrationUI(data.registrationOpen);
                    }
                } catch (error) {
                    console.error('Error loading registration status:', error);
                }
            }

            async loadTiers() {
                try {
                    const response = await fetch('/api/admin/tiers', {
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                    if (response.ok) {
                        this.availableTiers = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading tiers:', error);
                }
            }

            renderUsers(users) {
                if (users.length === 0) {
                    this.usersContainer.innerHTML = '<div class="empty-state"><h3>üë• No users found</h3></div>';
                    return;
                }

                const table = document.createElement('table');
                table.className = 'users-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Tier</th>
                            <th>Usage Today</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td><strong>${user.email}</strong></td>
                                <td>
                                    <span class="user-role ${user.is_admin ? 'admin' : ''}">
                                        ${user.is_admin ? 'üëë Admin' : 'üë§ User'}
                                    </span>
                                </td>
                                <td>
                                    <select onchange="adminManager.changeUserTier(${user.id}, this.value)" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd; font-size: 12px;">
                                        ${this.availableTiers.map(tier => `
                                            <option value="${tier.id}" ${user.tier_id === tier.id ? 'selected' : ''}>
                                                ${tier.name} (${tier.daily_limit === -1 ? '‚àû' : tier.daily_limit}/day)
                                            </option>
                                        `).join('')}
                                    </select>
                                </td>
                                <td>
                                    <span style="font-weight: 600; color: ${user.usage_today >= (user.daily_limit * 0.8) && user.daily_limit !== -1 ? '#dc3545' : '#28a745'};">
                                        ${user.usage_today || 0}${user.daily_limit !== -1 ? `/${user.daily_limit}` : ''}
                                    </span>
                                </td>
                                <td>
                                    <span class="user-status ${user.is_active ? 'active' : 'inactive'}">
                                        ${user.is_active ? '‚úÖ Active' : '‚ùå Inactive'}
                                    </span>
                                </td>
                                <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                <td>
                                    <div class="user-actions">
                                        ${user.id !== this.currentUser.id ? `
                                            <button class="action-btn small warning" onclick="adminManager.toggleUser(${user.id})">
                                                ${user.is_active ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                                            </button>
                                            <button class="action-btn small danger" onclick="adminManager.deleteUser(${user.id}, '${user.email}')">
                                                üóëÔ∏è Delete
                                            </button>
                                        ` : '<em>Current user</em>'}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                this.usersContainer.innerHTML = '';
                this.usersContainer.appendChild(table);
            }

            renderInvites(invites) {
                if (invites.length === 0) {
                    this.invitesContainer.innerHTML = '<div class="empty-state"><h3>‚úâÔ∏è No pending invitations</h3><p>Send invitations to invite new users</p></div>';
                    return;
                }

                const table = document.createElement('table');
                table.className = 'invites-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Invited By</th>
                            <th>Created</th>
                            <th>Expires</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invites.map(invite => `
                            <tr>
                                <td><strong>${invite.email}</strong></td>
                                <td>${invite.invited_by_email}</td>
                                <td>${new Date(invite.created_at).toLocaleDateString()}</td>
                                <td>${new Date(invite.expires_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                this.invitesContainer.innerHTML = '';
                this.invitesContainer.appendChild(table);
            }

            updateUserStats(users) {
                this.totalUsers.textContent = users.length;
                this.activeUsers.textContent = users.filter(u => u.is_active).length;
            }

            updateInviteStats(invites) {
                this.pendingInvites.textContent = invites.length;
            }

            updateStats() {
                // Additional stats can be updated here
            }

            updateRegistrationUI(isOpen) {
                this.registrationToggle.classList.toggle('active', isOpen);
                this.registrationStatus.textContent = isOpen ? 'Open' : 'Closed';
                this.registrationDescription.innerHTML = isOpen 
                    ? '<span style="color: #28a745;">‚úÖ Public registration is enabled</span>'
                    : '<span style="color: #dc3545;">üîí Registration closed - invite only</span>';
            }

            async toggleRegistration() {
                try {
                    const response = await fetch('/api/admin/registration/toggle', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.updateRegistrationUI(data.registrationOpen);
                        this.showNotification(data.message, 'success');
                    } else {
                        throw new Error('Failed to toggle registration');
                    }
                } catch (error) {
                    console.error('Error toggling registration:', error);
                    this.showNotification('Failed to update registration status', 'error');
                }
            }

            async sendInvitation() {
                const email = this.inviteEmail.value.trim();
                if (!email) {
                    this.showNotification('Please enter an email address', 'error');
                    return;
                }

                try {
                    this.sendInviteBtn.disabled = true;
                    this.sendInviteBtn.innerHTML = '<span>üì§ Sending...</span>';

                    const response = await fetch('/api/admin/invite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.showNotification(data.message, 'success');
                        this.inviteEmail.value = '';
                        this.loadInvites(); // Refresh invites list
                    } else {
                        this.showNotification(data.error, 'error');
                    }
                } catch (error) {
                    console.error('Error sending invitation:', error);
                    this.showNotification('Failed to send invitation', 'error');
                } finally {
                    this.sendInviteBtn.disabled = false;
                    this.sendInviteBtn.innerHTML = '<span>üìß Send Invitation</span>';
                }
            }

            async toggleUser(userId) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/toggle`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showNotification(data.message, 'success');
                        this.loadUsers(); // Refresh users list
                    } else {
                        throw new Error('Failed to toggle user status');
                    }
                } catch (error) {
                    console.error('Error toggling user:', error);
                    this.showNotification('Failed to update user status', 'error');
                }
            }

            async deleteUser(userId, email) {
                if (!confirm(`Are you sure you want to delete user "${email}"? This action cannot be undone.`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showNotification(data.message, 'success');
                        this.loadUsers(); // Refresh users list
                    } else {
                        const data = await response.json();
                        this.showNotification(data.error, 'error');
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    this.showNotification('Failed to delete user', 'error');
                }
            }

            async changeUserTier(userId, tierId) {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/tier`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.authToken}`
                        },
                        body: JSON.stringify({ tierId: parseInt(tierId) })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showNotification(data.message, 'success');
                        this.loadUsers(); // Refresh users list to show updated tier
                    } else {
                        const data = await response.json();
                        this.showNotification(data.error, 'error');
                        this.loadUsers(); // Refresh to revert dropdown selection
                    }
                } catch (error) {
                    console.error('Error changing user tier:', error);
                    this.showNotification('Failed to update user tier', 'error');
                    this.loadUsers(); // Refresh to revert dropdown selection
                }
            }

            async logout() {
                try {
                    await fetch('/api/auth/logout', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.authToken}` }
                    });
                } catch (error) {
                    console.error('Logout request failed:', error);
                } finally {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_email');
                    window.location.href = '/auth';
                }
            }

            setLoading(containerId, loading) {
                const container = document.getElementById(containerId);
                if (loading) {
                    container.classList.add('loading');
                } else {
                    container.classList.remove('loading');
                }
            }

            showNotification(message, type) {
                this.notification.textContent = message;
                this.notification.className = `notification ${type}`;
                this.notification.style.display = 'block';

                setTimeout(() => {
                    this.notification.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize admin manager when page loads
        let adminManager;
        document.addEventListener('DOMContentLoaded', () => {
            adminManager = new AdminUserManager();
        });
    </script>
</body>
</html>